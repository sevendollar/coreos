---
passwd:
  users:
    - name: jeffl
      password_hash: "$1$linux$Jkofsu0Cak8oAy8lOAOPB0"
      ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDAP6OO9UCi9a4KJZ4ikZFmxmk9IJLSXIeBVBBd/z+hxwH1L42+O6LUimMsVW9f2KS2//2i7BgAJFe93XxXr8EfCC+nTOORFMGP3copkvDp57Kofu+Tfb/DAcSyYPT3K4ilMv/j4CW/RiBgG/YAsSUeEbO+i5S8YolR/CdK0awGx6Q4DcX2yrOECfv+hv2Fq4UyVdaURSo8jtFhD3AfY50eb5G11SWbwqz0wDJV2Xlhb2UykjPEbCwSsYMurU6FYbFlOzRKUs1c5R+OD11dk2uwLSdM6L1ZVcleLo8hsaB0Zw3Pkj1sPxiGHITHGUxr4weUJjlYdTyXaXy9fowBIcS3 jeffl@jumper-amc
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDRcJWlhZTxUNxYVGvVhqkTD2+NyIi6wASdoqm+jfQkF2lnxKROVpODCZ9Yw7J6/V0dQZDc58vAm+tExySB4qkXpvTR0pUrtDZDu0ZiX9E1ErsW14JZKsUCJbJ9z5L41eI13k637vD+o3QGCM7OkdDc0wn8w089EPEcTVXjLhKEtzU6dwkas59mklQNzL4CfaoIFG7nqzuh12nCsXMmrSoP50Crywor4Xu9vgkNse60NENO4uwsrlvEL5sOPGOe1vbEaX8DTkjjA6SVoxKklzSQApZLzQR76ZnQPrAP8ut9qCavJcEV5r14GOBrL1qm0Wz9fBaf3aTBXzI5LZMTT3fz Jeff@Jeffs-MacBook-Air.local
      create:
        home_dir: /home/jeffl
        groups:
          - docker
          - sudo
        shell: /bin/bash

    - name: core
      password_hash: "$1$linux$Jkofsu0Cak8oAy8lOAOPB0"
      ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDAP6OO9UCi9a4KJZ4ikZFmxmk9IJLSXIeBVBBd/z+hxwH1L42+O6LUimMsVW9f2KS2//2i7BgAJFe93XxXr8EfCC+nTOORFMGP3copkvDp57Kofu+Tfb/DAcSyYPT3K4ilMv/j4CW/RiBgG/YAsSUeEbO+i5S8YolR/CdK0awGx6Q4DcX2yrOECfv+hv2Fq4UyVdaURSo8jtFhD3AfY50eb5G11SWbwqz0wDJV2Xlhb2UykjPEbCwSsYMurU6FYbFlOzRKUs1c5R+OD11dk2uwLSdM6L1ZVcleLo8hsaB0Zw3Pkj1sPxiGHITHGUxr4weUJjlYdTyXaXy9fowBIcS3 jeffl@jumper-amc
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDRcJWlhZTxUNxYVGvVhqkTD2+NyIi6wASdoqm+jfQkF2lnxKROVpODCZ9Yw7J6/V0dQZDc58vAm+tExySB4qkXpvTR0pUrtDZDu0ZiX9E1ErsW14JZKsUCJbJ9z5L41eI13k637vD+o3QGCM7OkdDc0wn8w089EPEcTVXjLhKEtzU6dwkas59mklQNzL4CfaoIFG7nqzuh12nCsXMmrSoP50Crywor4Xu9vgkNse60NENO4uwsrlvEL5sOPGOe1vbEaX8DTkjjA6SVoxKklzSQApZLzQR76ZnQPrAP8ut9qCavJcEV5r14GOBrL1qm0Wz9fBaf3aTBXzI5LZMTT3fz Jeff@Jeffs-MacBook-Air.local

storage:
  filesystems:
    - name: filesystem1
      mount:
        device: /dev/disk/by-partlabel/ROOT
        format: btrfs
        create:
          force: true
          options:
            - -L
            - ROOT
  files:
    - filesystem: filesystem1
      path: /etc/hostname
      contents:
        inline: etcd-1
      mode: 0420
#    - filesystem: filesystem1
#      path: /etc/hosts
#      contents:
#        remote:
#          url: http://10.7.12.65:32771/hosts
#      mode: 0644
    - filesystem: filesystem1
      path: /etc/ssl/certs/ca.pem
      contents:
        remote:
          url: http://10.7.12.65:32771/ca.pem
      mode: 0644
    - filesystem: filesystem1
      path: /etc/ssl/certs/server.pem
      contents:
        remote:
          url: http://10.7.12.65:32771/server.pem
      mode: 0644
    - filesystem: filesystem1
      path: /etc/ssl/certs/server-key.pem
      contents:
        remote:
          url: http://10.7.12.65:32771/server-key.pem
      mode: 0644
    - filesystem: filesystem1
      path: /etc/ssl/certs/client-key.pem
      contents:
        remote:
          url: http://10.7.12.65:32771/client-key.pem
      mode: 0644
    - filesystem: filesystem1
      path: /etc/ssl/certs/client.pem
      contents:
        remote:
          url: http://10.7.12.65:32771/client.pem
      mode: 0644

systemd:
  units:
    - name: flanneld.service
      dropins:
        - name: 50-ssl.conf
          contents: |
            [Service]
            Environment="ETCD_SSL_DIR=/etc/ssl/certs"
        - name: 50-network-config.conf
          contents: |
            [Service]
            ExecStartPre=/usr/bin/etcdctl --ca-file=/etc/ssl/certs/ca.pem --key-file=/etc/ssl/certs/client-key.pem --cert-file=/etc/ssl/certs/client.pem --endpoints=https://10.5.1.201:2379,https://10.5.1.202:2379,https://10.5.1.203:2379 set /coreos.com/network/config '{ "Network": "10.1.0.0/16" }'
    - name: locksmithd.service
      dropins:
        - name: 20-locksmithd-config.conf
          contents: |
            [Service]
            Environment="LOCKSMITHD_ETCD_CAFILE=/etc/ssl/certs/ca.pem"
            Environment="LOCKSMITHD_ETCD_CERTFILE=/etc/ssl/certs/client.pem"
            Environment="LOCKSMITHD_ETCD_KEYFILE=/etc/ssl/certs/client-key.pem"
            Environment="LOCKSMITHD_ENDPOINT=https://10.5.1.201:2379,https://10.5.1.202:2379,https://10.5.1.203:2379"
    - name: etcd-member.service
      dropins:
        - name: conf1.conf
          contents: |
            [Service]
            Environment="ETCD_SSL_DIR=/etc/ssl/certs"

networkd:
  units:
    - name: static.network
      contents: |
        [Match]
        Name=ens*

        [Network]
        DNS=10.5.15.106
        Domains=cvl.com.tw
        Address=10.5.1.201/24
        Gateway=10.5.1.254

flannel:
  etcd_endpoints: https://10.5.1.201:2379,https://10.5.1.202:2379,https://10.5.1.203:2379
  etcd_cafile: /etc/ssl/certs/ca.pem
  etcd_certfile: /etc/ssl/certs/client.pem
  etcd_keyfile: /etc/ssl/certs/client-key.pem

etcd:
  version: 3.2.0
  name: etcd-1
  data_dir: /var/lib/etcd
  advertise_client_urls: https://10.5.1.201:2379
  initial_advertise_peer_urls: https://10.5.1.201:2380
  listen_client_urls: https://0.0.0.0:2379
  listen_peer_urls: https://10.5.1.201:2380
#  discovery: https://discovery.etcd.io/8865a4e3fde9d6dca0d74628a2536998
  initial_cluster: etcd-1=https://10.5.1.201:2380,etcd-2=https://10.5.1.202:2380,etcd-3=https://10.5.1.203:2380
  initial_cluster_token: mytoken
  initial_cluster_state: new
  client_cert_auth: true
  trusted_ca_file: /etc/ssl/certs/ca.pem
  cert_file: /etc/ssl/certs/server.pem
  key_file: /etc/ssl/certs/server-key.pem
  peer_client_cert_auth: true
  peer_trusted_ca_file: /etc/ssl/certs/ca.pem
  peer_cert_file: /etc/ssl/certs/server.pem
  peer_key_file: /etc/ssl/certs/server-key.pem
  auto_compaction_retention: 1

update:
  group: stable
locksmith:
  reboot_strategy: etcd-lock
  window_start: Sun 1:00
  window_length: 2h
  etcd_endpoints: https://10.5.1.201:2379,https://10.5.1.202:2379,https://10.5.1.203:2379
  etcd_cafile: /etc/ssl/certs/ca.pem
  etcd_certfile: /etc/ssl/certs/client.pem
  etcd_keyfile: /etc/ssl/certs/client-key.pem
